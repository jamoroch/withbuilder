/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package co.xapuka.withbuilder;

import javax.annotation.processing.AbstractProcessor;
import javax.annotation.processing.RoundEnvironment;
import javax.lang.model.SourceVersion;
import javax.lang.model.element.Element;
import javax.lang.model.element.TypeElement;
import javax.tools.Diagnostic;
import javax.tools.JavaFileObject;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

import static javax.lang.model.element.ElementKind.*;

public class WithBuilderProcessor  extends AbstractProcessor {
    public boolean someLibraryMethod() {
        return true;
    }

    @Override
    public boolean process(Set<? extends TypeElement> annotations, RoundEnvironment roundEnv) {
        if(annotations == null || annotations.isEmpty()) {
            return false;
        }
        pm("Processing WithBuilder...");

        Set<? extends Element> annotatedElements = roundEnv.getElementsAnnotatedWith(annotations.iterator().next());
        annotatedElements.forEach(ann -> {

            TypeElement typeElement = getTypeElement(ann);

            ClassAndPackageName classAndPackageName = ClassAndPackageName.from(typeElement, ann.getAnnotation(WithBuilder.class).suffix());

            Map<String, String> fieldsAndTheirTypes = ann.getEnclosedElements().stream()
                    .filter(e -> FIELD == e.getKind())
                    .collect(Collectors.toMap(e -> e.getSimpleName().toString(), e -> e.asType().toString()));
            try {
                writeFile(classAndPackageName, ann ,fieldsAndTheirTypes);
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
        });

        return false;
    }

    private void writeFile(ClassAndPackageName classAndPackageName, Element ann ,Map<String, String> fieldsAndTheirTypes) throws IOException {
        JavaFileObject builderFile = processingEnv.getFiler().createSourceFile(classAndPackageName.getBuilderClassName(), ann);
        try (PrintWriter out = new PrintWriter(builderFile.openWriter())) {
        out.println("package " + classAndPackageName.getPackageName() + ";");
        out.println("public final class " + classAndPackageName.getBuilderClassName() + "{");
        out.println("}");
        }
    }

    private TypeElement getTypeElement(Element ann) {
        TypeElement typeElement = ann.getEnclosedElements()
                .stream()
                .filter(e -> CONSTRUCTOR == e.getKind())
                .map(e -> e.getEnclosingElement())
                .map(e -> (TypeElement) e)
                .reduce((x, y) -> x)
                .orElseThrow(RuntimeException::new);
        return typeElement;
    }

    @Override
    public SourceVersion getSupportedSourceVersion() {
        return SourceVersion.latest();
    }

    @Override
    public Set<String> getSupportedAnnotationTypes() {
        return Set.of(WithBuilder.class.getName());
    }

    private void pm(String message) {
        processingEnv.getMessager().printMessage(Diagnostic.Kind.NOTE, message);
    }
}
